<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
      integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
      crossorigin="anonymous"
    ></script>
    <!-- Amcharts -->
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/stock.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>

    <!-- Styles -->
    <style>
      #chartcontrols {
        height: auto;
        padding: 5px 5px 0 16px;
        max-width: 100%;
        background-color: white;
      }

      #chartdiv {
        display: flex;
        justify-content: flex-start;
        width: 100%;
        height: 300px;
        max-width: 100%;
        background-color: white;
      }

      .header div {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-direction: row;
      }

      body {
        background-color: white;
      }
    </style>
  </head>
  <body>
    {% load static %}
    <div
      class="container mx-auto mt-3"
      style="border-radius: 15px; background-color: #24146c"
    >
      <div class="row shadow-lg p-2" style="border-radius: 15px">
        <div
          class="col-3 p-3 overflow-y-scroll shadow-lg bg-dark"
          style="
            border-radius: 15px;
            max-height: 95vh;
            background: linear-gradient(
              132deg,
              rgb(244, 4, 4) 0%,
              rgb(249, 93, 3) 0%,
              rgb(255, 238, 0) 100%
            );
          "
        >
          <h4 class="fw-bold text-center">Analyze Ticker</h4>
          {% for tkr, name in tickers %}
          <a href="{% url 'stock_chart:display_ticker' tkr %}">
            <div class="card mb-2 shadow-lg bg-dark-subtle">
              <div class="card-body fw-bold">{{ name }} ({{ tkr }})</div>
            </div>
          </a>
          {% endfor %}
        </div>

        <div
          class="col-9 text-light overflow-y-scroll"
          style="max-height: 100vh"
        >
          <h1 class="text-center">Stock Analysis Dashboard</h1>

          <!-- Company Information -->
          <div class="text-center mb-3 header">
            <h4>{{ name }}</h4>
            <div>
              <p><span style="color: cyan">Industry:</span> {{ industry }}</p>
              <p>
                <span style="color: rgb(225, 0, 255)">Sector:</span> {{ sector
                }}
              </p>
            </div>
          </div>

          <div id="chartcontrols"></div>
          <div id="chartdiv"></div>

          <script>
            am5.ready(function () {
              // Create root element
              var root = am5.Root.new("chartdiv");

              const myTheme = am5.Theme.new(root);
              myTheme
                .rule("Grid", ["scrollbar", "minor"])
                .setAll({ visible: false });
              root.setThemes([am5themes_Animated.new(root), myTheme]);

              // Set themes
              root.setThemes([am5themes_Animated.new(root)]);

              // Create a stock chart
              var stockChart = root.container.children.push(
                am5stock.StockChart.new(root, { paddingRight: 0 })
              );

              // Set global number format
              root.numberFormatter.set("numberFormat", "#,###.00");

              // Create main stock panel
              var mainPanel = stockChart.panels.push(
                am5stock.StockPanel.new(root, {
                  wheelY: "zoomX",
                  panX: true,
                  panY: true,
                  height: am5.percent(70),
                })
              );

              // Create axes
              // Create value axis
              var valueAxis = mainPanel.yAxes.push(
                am5xy.ValueAxis.new(root, {
                  renderer: am5xy.AxisRendererY.new(root, { pan: "zoom" }),
                  extraMin: 0.1,
                  tooltip: am5.Tooltip.new(root, {}),
                  numberFormat: "#,###.00",
                  extraTooltipPrecision: 2,
                })
              );

              // Create date axis
              var dateAxis = mainPanel.xAxes.push(
                am5xy.GaplessDateAxis.new(root, {
                  baseInterval: { timeUnit: "minute", count: 1 },
                  renderer: am5xy.AxisRendererX.new(root, {
                    pan: "zoom",
                    minorGridEnabled: true,
                  }),
                  tooltip: am5.Tooltip.new(root, {}),
                })
              );

              // Add series
              var valueSeries = mainPanel.series.push(
                am5xy.CandlestickSeries.new(root, {
                  name: "Stock Data",
                  clustered: false,
                  valueXField: "date", // Changed to 'date'
                  valueYField: "Close",
                  highValueYField: "High",
                  lowValueYField: "Low",
                  openValueYField: "Open",
                  calculateAggregates: true,
                  xAxis: dateAxis,
                  yAxis: valueAxis,
                  legendValueText:
                    "open: [bold]{openValueY}[/] high: [bold]{highValueY}[/] low: [bold]{lowValueY}[/] close: [bold]{valueY}[/]",
                  legendRangeValueText: "",
                })
              );

              // Set data to the series
              var rawData = JSON.parse("{{ hist_data|escapejs }}"); // Ensure hist_data is in JSON format
              var transformedData = rawData.map((item) => ({
                date: new Date(item.Datetime).getTime(), // Convert to epoch time
                Close: item.Close,
                High: item.High,
                Low: item.Low,
                Open: item.Open,
                Volume: item.Volume,
              }));
              console.log(transformedData);
              valueSeries.data.setAll(transformedData);

              // Add a stock legend
              var valueLegend = mainPanel.plotContainer.children.push(
                am5stock.StockLegend.new(root, {
                  stockChart: stockChart,
                })
              );

              // Create volume axis and series
              var volumeAxisRenderer = am5xy.AxisRendererY.new(root, {});
              volumeAxisRenderer.labels.template.set("forceHidden", true);
              volumeAxisRenderer.grid.template.set("forceHidden", true);

              var volumeValueAxis = mainPanel.yAxes.push(
                am5xy.ValueAxis.new(root, {
                  numberFormat: "#.#a",
                  height: am5.percent(20),
                  y: am5.percent(100),
                  centerY: am5.percent(100),
                  renderer: volumeAxisRenderer,
                })
              );

              var volumeSeries = mainPanel.series.push(
                am5xy.ColumnSeries.new(root, {
                  name: "Volume",
                  clustered: false,
                  valueXField: "date", // Changed to 'date'
                  valueYField: "Volume",
                  xAxis: dateAxis,
                  yAxis: volumeValueAxis,
                  legendValueText: "[bold]{valueY.formatNumber('#,###.0a')}[/]",
                })
              );

              volumeSeries.columns.template.setAll({
                strokeOpacity: 0,
                fillOpacity: 0.5,
              });

              // Set main series
              stockChart.set("volumeSeries", volumeSeries);
              valueLegend.data.setAll([valueSeries, volumeSeries]);

              // Add cursor
              mainPanel.set(
                "cursor",
                am5xy.XYCursor.new(root, {
                  yAxis: valueAxis,
                  xAxis: dateAxis,
                  snapToSeries: [valueSeries],
                  snapToSeriesBy: "y!",
                })
              );

              // Add scrollbar
              var scrollbar = mainPanel.set(
                "scrollbarX",
                am5xy.XYChartScrollbar.new(root, {
                  orientation: "horizontal",
                  height: 50,
                })
              );
              stockChart.toolsContainer.children.push(scrollbar);

              var sbDateAxis = scrollbar.chart.xAxes.push(
                am5xy.GaplessDateAxis.new(root, {
                  baseInterval: { timeUnit: "minute", count: 1 },
                  renderer: am5xy.AxisRendererX.new(root, {
                    minorGridEnabled: true,
                  }),
                })
              );

              var sbValueAxis = scrollbar.chart.yAxes.push(
                am5xy.ValueAxis.new(root, {
                  renderer: am5xy.AxisRendererY.new(root, {}),
                })
              );

              var sbSeries = scrollbar.chart.series.push(
                am5xy.LineSeries.new(root, {
                  valueYField: "Close",
                  valueXField: "date", // Changed to 'date'
                  xAxis: sbDateAxis,
                  yAxis: sbValueAxis,
                })
              );

              sbSeries.fills.template.setAll({
                visible: true,
                fillOpacity: 0.3,
              });

              // Function that dynamically loads data
              function loadData(ticker, series) {
                am5.net
                  .load(
                    "https://www.amcharts.com/wp-content/uploads/assets/docs/stock/" +
                      ticker +
                      ".csv"
                  )
                  .then(function (result) {
                    var data = am5.CSVParser.parse(result.response, {
                      delimiter: ",",
                      skipEmpty: true,
                      useColumnNames: true,
                    });

                    var processor = am5.DataProcessor.new(root, {
                      dateFields: ["Date"],
                      dateFormat: "yyyy-MM-dd",
                      numericFields: [
                        "Open",
                        "High",
                        "Low",
                        "Close",
                        "Adj Close",
                        "Volume",
                      ],
                    });
                    processor.processMany(data);

                    am5.array.each(series, function (item) {
                      item.data.setAll(data);
                    });
                  });
              }

              // Load initial data for the first series
              loadData("MSFT", [valueSeries, sbSeries]);

              // Custom settings control
              var seriesSwitcher = am5stock.SeriesTypeControl.new(root, {
                stockChart: stockChart,
              });

              seriesSwitcher.events.on("selected", function (ev) {
                setSeriesType(ev.item.id);
              });

              function getNewSettings(series) {
                var newSettings = [];
                am5.array.each(
                  [
                    "name",
                    "valueYField",
                    "highValueYField",
                    "lowValueYField",
                    "openValueYField",
                    "calculateAggregates",
                    "valueXField",
                    "xAxis",
                    "yAxis",
                    "legendValueText",
                    "stroke",
                    "fill",
                  ],
                  function (setting) {
                    newSettings[setting] = series.get(setting);
                  }
                );
                return newSettings;
              }

              function setSeriesType(seriesType) {
                var currentSeries = stockChart.get("stockSeries");
                var newSettings = getNewSettings(currentSeries);
                var data = currentSeries.data.values;
                mainPanel.series.removeValue(currentSeries);

                var series;
                switch (seriesType) {
                  case "line":
                    series = mainPanel.series.push(
                      am5xy.LineSeries.new(root, newSettings)
                    );
                    break;
                  case "candlestick":
                  case "procandlestick":
                    newSettings.clustered = false;
                    series = mainPanel.series.push(
                      am5xy.CandlestickSeries.new(root, newSettings)
                    );
                    if (seriesType == "procandlestick") {
                      series.columns.template.get("themeTags").push("pro");
                    }
                    break;
                  case "ohlc":
                    newSettings.clustered = false;
                    series = mainPanel.series.push(
                      am5xy.OHLCSeries.new(root, newSettings)
                    );
                    break;
                }

                if (series) {
                  valueLegend.data.removeValue(currentSeries);
                  series.data.setAll(data);
                  stockChart.set("stockSeries", series);
                  var cursor = mainPanel.get("cursor");
                  if (cursor) {
                    cursor.set("snapToSeries", [series]);
                  }
                  valueLegend.data.insertIndex(0, series);
                }
              }

              // Add toolbar
              var toolbar = am5stock.StockToolbar.new(root, {
                container: document.getElementById("chartcontrols"),
                stockChart: stockChart,
                controls: [
                  seriesSwitcher,
                  am5stock.ResetControl.new(root, {
                    stockChart: stockChart,
                  }),
                  am5stock.SettingsControl.new(root, {
                    stockChart: stockChart,
                  }),
                ],
              });
            });
          </script>
        </div>
      </div>
    </div>
  </body>
</html>
